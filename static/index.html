<!DOCTYPE html>
<html>
<head>
<title>Camera Crowd</title>
<style>
  body { margin: 0; }
  canvas { width: 100%; height: 100% }
</style>
</head>
<body>
<script src="js/three.min.js"></script>
<script src="js/PointerLockControls.js"></script>
<script src="js/StereoEffect.js"></script>
<script src="js/DeviceOrientationControls.js"></script>
<script src="js/OrbitControls.js"></script>
<script>
  var scene = new THREE.Scene();
  var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  
  var renderer = new THREE.WebGLRenderer();
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  ptr_controls = new THREE.PointerLockControls(camera);
  ptr_controls.enabled = true;
  ptr_controls.getObject().position.y = 0;
  scene.add(ptr_controls.getObject());

  var effect = renderer;
  var dev_controls = null;

  function fullscreen() {
    var container = document.body;
    if (container.requestFullscreen) {
      container.requestFullscreen();
    } else if (container.msRequestFullscreen) {
      container.msRequestFullscreen();
    } else if (container.mozRequestFullScreen) {
      container.mozRequestFullScreen();
    } else if (container.webkitRequestFullscreen) {
      container.webkitRequestFullscreen();
    }
  }

  function setOrientationControls(e) {
    if (!e.alpha) return;
    effect = new THREE.StereoEffect(renderer);
    effect.setSize(window.innerWidth, window.innerHeight);
    dev_controls = new THREE.DeviceOrientationControls(camera, true);
    dev_controls.connect();
    dev_controls.update();
    renderer.domElement.addEventListener('click', fullscreen, false);
    window.removeEventListener('deviceorientation', setOrientationControls, true);
  }
  window.addEventListener('deviceorientation', setOrientationControls, true);


  var geometry = new THREE.BoxGeometry(100, 100, 100);

  textureCube = THREE.ImageUtils.loadTextureCube([
    'img/pos-x.jpg',
    'img/neg-x.jpg',
    'img/pos-y.jpg',
    'img/neg-y.jpg',
    'img/pos-z.jpg',
    'img/neg-z.jpg'
  ]);
  textureCube.format = THREE.RGBFormat;

  var shader = THREE.ShaderLib['cube'];
  var uniforms = THREE.UniformsUtils.clone(shader.uniforms);
  uniforms['tCube'].value = textureCube;
  var material = new THREE.ShaderMaterial( {
    fragmentShader: shader.fragmentShader,
    vertexShader: shader.vertexShader,
    uniforms: uniforms,
    depthWrite: false,
    side: THREE.BackSide
  });

  var cube = new THREE.Mesh(geometry, material);
  scene.add(cube);

  function render() {
    if (dev_controls) dev_controls.update()
    effect.render(scene, camera);
  }
  window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    effect.setSize(window.innerWidth, window.innerHeight);
    render();
  }, false);

  function animate() {
    render();
    requestAnimationFrame(animate);
  }

  var textureLoader = new THREE.TextureLoader();

  var source = new EventSource("/events");
  source.onmessage = function(event) {
    var messages = JSON.parse(event.data);
    console.log("Got messages", messages);
    for (var ii = 0; ii < messages.length; ii++) {
      var message = messages[ii];

      textureLoader.load("/photos/" + message.id, function(texture) {
        texture.minFilter = THREE.LinearFilter;
        var geometry = new THREE.PlaneBufferGeometry(0.25, 0.25);
        geometry.uvsNeedUpdate = true;
        var material = new THREE.MeshBasicMaterial({map: texture, side: THREE.DoubleSide});
        var plane = new THREE.Mesh(geometry, material);
        plane.position.x = message.json[0][0];
        plane.position.y = message.json[1][0];
        plane.position.z = message.json[2][0];
        scene.add(plane);
      });
    }
  };
  //window.setInterval(function() {
  //  source.onmessage({data: JSON.stringify({url: "img/pos-x.png", json: [[Math.random() * 2 - 1], [Math.random() * 2 - 1], [-Math.random() - 2]]})});
  //}, 1000);

  animate();
</script>
</body>
</html>
