<!DOCTYPE html>
<html>
<head>
<title>Camera Crowd</title>
<style>
  body { margin: 0; }
  canvas { width: 100%; height: 100% }
</style>
</head>
<body>
<script src="js/three.min.js"></script>
<script src="js/PointerLockControls.js"></script>
<script src="js/tween.min.js"></script>
<script>
  var scene = new THREE.Scene();
  var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.001, 100000);
  
  var renderer = new THREE.WebGLRenderer();
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new THREE.PointerLockControls(camera);
  controls.enabled = true;
  controls.getObject().position.y = 0;
  scene.add(controls.getObject());

  var geometry = new THREE.BoxGeometry(1, 1, 1);

  textureCube = THREE.ImageUtils.loadTextureCube([
    'img/pos-x.jpg',
    'img/neg-x.jpg',
    'img/pos-y.jpg',
    'img/neg-y.jpg',
    'img/pos-z.jpg',
    'img/neg-z.jpg'
  ]);
  textureCube.format = THREE.RGBFormat;

  var shader = THREE.ShaderLib['cube'];
  var uniforms = THREE.UniformsUtils.clone(shader.uniforms);
  uniforms['tCube'].value = textureCube;
  var material = new THREE.ShaderMaterial( {
    fragmentShader: shader.fragmentShader,
    vertexShader: shader.vertexShader,
    uniforms: uniforms,
    depthWrite: false,
    side: THREE.BackSide
  });

  var cube = new THREE.Mesh(geometry, material);
  scene.add(cube);

  function render() {
    renderer.render(scene, camera);
  }
  window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    render();
  }, false);

  function animate() {
    TWEEN.update();
    render();
    requestAnimationFrame(animate);
  }

  var textureLoader = new THREE.TextureLoader();

  //var source = new EventSource("/events");
  var source = {};
  source.onmessage = function(event) {
    var messages = JSON.parse(event.data);
    console.log("Got messages", messages);
    for (var ii = 0; ii < messages.length; ii++) {
      (function(message, delay) {
        window.setTimeout(function() {
          var planeHolder = new THREE.Object3D();
          planeHolder.matrixAutoUpdate = false;
          planeHolder.matrix.set.apply(planeHolder.matrix, message.json);
          scene.add(planeHolder);

          textureLoader.load(message.url, function(texture) {
            texture.minFilter = THREE.LinearFilter;
            var geometry = new THREE.PlaneBufferGeometry(2, 2 * texture.image.height / texture.image.width);
            var material = new THREE.MeshBasicMaterial({map: texture, side: THREE.DoubleSide, transparent: true});
            var plane = new THREE.Mesh(geometry, material);
            planeHolder.add(plane);
  
            // Animate
            new TWEEN.Tween({scale: 0, z: 2}).to({scale: 1, z: 0}, 2000)
            .easing(TWEEN.Easing.Elastic.Out)
            .onUpdate(function() {
              plane.scale.x = this.scale;
              plane.scale.y = this.scale;
              plane.scale.z = this.scale;
              plane.position.z = this.z;
            }).chain(new TWEEN.Tween({alpha: 1}).to({alpha: 0}, 1000)
              .easing(TWEEN.Easing.Linear.None)
              .onUpdate(function() {
                material.opacity = this.alpha;
              }).onComplete(function() {
                scene.remove(planeHolder);
              }))
            .start();
          });
        }, delay);
      })(messages[ii], (ii + Math.random()) * 3000);
    }
  };
  window.setTimeout(function() {
    source.onmessage({data: JSON.stringify(
      [
{url: "../photos/1", id: 1, json:
[-0.23895488067872647, -0.2863602375054499, -0.9278460968154352, 2.1417553378329033, -0.08980157888735206, 0.9579491276735953, -0.27252365992466865, 1.848506162718504, 0.9668692990415789, 0.018201185819063923, -0.2546222209580806, 1.3987007689509268, 0.0, 0.0, 0.0, 1.0]
},
{url: "../neg-x.jpg", id: 1, json:
[-3.1888783969374273e-16, 1.6734708828771265e-16, -1.0, 1.0000000000000007, 2.4350842353448633e-16, 1.0, 1.6734708828771265e-16, -7.154583992017251e-16, 1.0, -2.4350842353448633e-16, -3.1888783969374273e-16, 8.429814400254839e-17, 0.0, 0.0, 0.0, 1.0]
},
{url: "../neg-x-scaled.jpg", id: 1, json:
[-0.0013754032495984626, -0.0016178961228603863, -0.9999977453364766, 0.9996152185781825, 0.00021995846048678742, 0.9999986665223933, -0.0016182001455103047, 0.0020584756150252128, 0.9999990299416178, -0.00022218364229308, -0.0013750455455886215, 0.0008860326296758462, 0.0, 0.0, 0.0, 1.0]
},
{url: "../neg-x-cropped.jpg", id: 1, json:
[0.002366480288468626, -0.0016682287224840308, -0.9999958083832021, 1.9997872923148343, -0.0003117374275871584, 0.999998558676693, -0.0016689710341916686, 0.0067531472629611825, 0.9999971512913527, 0.00031568570795771617, 0.002365956828274862, 0.9992424068447108, 0.0, 0.0, 0.0, 1.0]
},
{url: "../neg-x-rotated.jpg", id: 1, json:
[0.003554726286346023, -0.003416810377568153, -0.9999878445900594, 2.0008618205551376, 0.7068340528165117, 0.70737939794393, 9.562148217693027e-05, 0.007903907792062341, 0.7073704727368919, -0.706825800867036, 0.004929658067172925, 0.7057718914935511, 0.0, 0.0, 0.0, 1.0]
},
{url: "../neg-x-perspective.jpg", id: 1, json:
[0.4179410429728873, 0.09729066719680876, -0.9032495838222871, 1.0890369558420177, -0.05921138663223234, 0.99505223763286, 0.07978130153692997, -0.29758872615313625, 0.906542495579674, 0.02013877995902545, 0.42163388531988094, 0.5156323336942625, 0.0, 0.0, 0.0, 1.0]
},
      ])});
  }, 1000);

  animate();
</script>
</body>
</html>
